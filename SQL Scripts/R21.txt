WITH CTE_Counter AS (
    -- Primer registro (inicialización)
    SELECT 
        Fecha,
        RSI_SMA3,
        RSI_SMA7,
        CASE 
            WHEN ROUND(RSI_SMA3, 15) > ROUND(RSI_SMA7, 15) THEN 1
            WHEN ROUND(RSI_SMA3, 15) < ROUND(RSI_SMA7, 15) THEN -1
            ELSE 0
        END AS Counter
    FROM Datos2
    WHERE Fecha = (SELECT MIN(Fecha) FROM Datos2)

    UNION ALL
    
    -- Registros posteriores
    SELECT 
        D.Fecha,
        D.RSI_SMA3,
        D.RSI_SMA7,
        CASE 
            WHEN ROUND(D.RSI_SMA3, 15) > ROUND(D.RSI_SMA7, 15) THEN
                CASE 
                    WHEN C.Counter > 0 THEN C.Counter + 1 -- Incrementa si el anterior es positivo
                    ELSE 1 -- Reinicia si el anterior es negativo o cero
                END
            WHEN ROUND(D.RSI_SMA3, 15) < ROUND(D.RSI_SMA7, 15) THEN
                CASE 
                    WHEN C.Counter < 0 THEN C.Counter - 1 -- Decrementa si el anterior es negativo
                    ELSE -1 -- Reinicia si el anterior es positivo o cero
                END
            ELSE C.Counter -- Si son iguales, mantiene el valor anterior
        END AS Counter
    FROM Datos2 D
    INNER JOIN CTE_Counter C ON D.Fecha > C.Fecha 
        AND NOT EXISTS (
            SELECT 1 
            FROM Datos2 D2 
            WHERE D2.Fecha > C.Fecha AND D2.Fecha < D.Fecha
        )
)
SELECT *
FROM CTE_Counter
ORDER BY Fecha
OPTION (MAXRECURSION 0); -- Permitir más niveles de recursion

--------con R21, poniendo el counter en la columna R21--------

WITH CTE_Counter AS (
    -- Primer registro (inicialización)
    SELECT 
        Fecha,
        RSI_SMA3,
        RSI_SMA7,
        CASE 
            WHEN ROUND(RSI_SMA3, 15) > ROUND(RSI_SMA7, 15) THEN 1
            WHEN ROUND(RSI_SMA3, 15) < ROUND(RSI_SMA7, 15) THEN -1
            ELSE 0
        END AS Counter
    FROM Datos2
    WHERE Fecha = (SELECT MIN(Fecha) FROM Datos2)

    UNION ALL

    -- Registros posteriores
    SELECT 
        D.Fecha,
        D.RSI_SMA3,
        D.RSI_SMA7,
        CASE 
            WHEN ROUND(D.RSI_SMA3, 15) > ROUND(D.RSI_SMA7, 15) THEN
                CASE 
                    WHEN C.Counter > 0 THEN C.Counter + 1 -- Incrementa si el anterior es positivo
                    ELSE 1 -- Reinicia si el anterior es negativo o cero
                END
            WHEN ROUND(D.RSI_SMA3, 15) < ROUND(D.RSI_SMA7, 15) THEN
                CASE 
                    WHEN C.Counter < 0 THEN C.Counter - 1 -- Decrementa si el anterior es negativo
                    ELSE -1 -- Reinicia si el anterior es positivo o cero
                END
            ELSE C.Counter -- Si son iguales, mantiene el valor anterior
        END AS Counter
    FROM Datos2 D
    INNER JOIN CTE_Counter C ON D.Fecha > C.Fecha 
        AND NOT EXISTS (
            SELECT 1 
            FROM Datos2 D2 
            WHERE D2.Fecha > C.Fecha AND D2.Fecha < D.Fecha
        )
)
-- Actualizar la columna R21 con los resultados de Counter
UPDATE D
SET D.R21 = C.Counter
FROM Datos2 D
INNER JOIN CTE_Counter C
ON D.Fecha = C.Fecha
OPTION (MAXRECURSION 10000); -- Aumentar el límite de recursión
--------------

select Fecha,RSI_SMA3, RSI_SMA7, R21 from Datos2;
