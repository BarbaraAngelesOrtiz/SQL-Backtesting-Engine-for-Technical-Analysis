USE Michi;

-- CTE para calcular V2 y su anterior
WITH CTE_V2 AS (
    SELECT 
        Empresa,
        Fecha,
        EMA_10,
		EMA_20,
		EMA_40,
        LAG(EMA_10, 1) OVER (PARTITION BY Empresa ORDER BY Fecha) AS Prev_EMA_10,
		LAG(EMA_40, 1) OVER (PARTITION BY Empresa ORDER BY Fecha) AS Prev_EMA_40
    FROM 
        Datos2
)
-- Actualización de la columna V2
UPDATE D
SET D.V2 = CASE 
			   WHEN C.EMA_20<= C.EMA_40 AND C.EMA_10<= C.EMA_40 AND C.Prev_EMA_10 > C.Prev_EMA_40 THEN 1  -- Condición cumplida
               ELSE 0  -- No se cumple la condición
            END 
FROM Datos2 D

INNER JOIN CTE_V2 C
    ON D.Empresa = C.Empresa
    AND D.Fecha = C.Fecha
WHERE D.Empresa = 'RIO'  -- Filtra por la empresa deseada si es necesario